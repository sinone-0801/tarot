<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タロット占い</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .table-area {
            position: relative;
            z-index: 0;
            width: 100%;
            height: 800px;
            background: #2b1810;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .table-area {
                height: 600px;
            }
        }

        @media (max-width: 480px) {
            .table-area {
                height: 500px;
            }
        }

        .table-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                rgba(43, 24, 16, 0.1),
                rgba(43, 24, 16, 0.1) 5px,
                rgba(43, 24, 16, 0.2) 5px,
                rgba(43, 24, 16, 0.2) 10px
            );
            opacity: 0.3;
        }

        .shuffle-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 60%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            z-index: 2000;
        }

        .reading-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card {
            position: absolute;
            z-index: 3000;
            width: 162px;
            height: 241px;
            background-image: url('data/back.png');
            background-size: cover;
            border-radius: 10px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            transition: all 0.5s ease-out;
            transform-origin: center center;
            cursor: pointer;
            pointer-events: auto;
            user-select: none;
        }

        /* カードサイズの調整 */
        @media (max-width: 768px) {
            .card, .reading-card {
                width: 108px; /* 元の2/3サイズ */
                height: 160px;
            }
        }

        @media (max-width: 480px) {
            .card, .reading-card {
                width: 54px; /* 元の1/3サイズ */
                height: 80px;
            }
        }

        .reading-card {
            position: absolute;
            width: 162px;
            height: 241px;
            background-size: cover;
            border-radius: 10px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            cursor: default;
            transform-style: preserve-3d;
            transition: transform 0.8s ease-in-out;
        }

        @media (max-width: 768px) {
            .reading-card {
                width: 121px;
                height: 180px;
            }
        }

        @media (max-width: 480px) {
            .reading-card {
                width: 81px;
                height: 120px;
            }
        }

        .reading-card .front,
        .reading-card .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            background-size: cover;
        }

        .reading-card .front {
            background-size: 80% auto;
            background-position: center center;
            background-repeat: no-repeat;
            background-color: white;
            transform: rotateY(180deg);
        }

        .reading-card .back {
            background-image: url('data/back.png');
        }

        .reading-card.revealed {
            transform: rotateY(180deg);
        }

        .reading-card.reversed .front {
            transform: rotateY(180deg) rotate(180deg);
        }

        /* ベースとなるボタンスタイル */
        .button, .pile-button {
            padding: 15px 30px;
            font-size: 1.2em;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
        }

        .button:hover, .pile-button:hover {
            background-color: #357abd;
        }

        .button:disabled, .pile-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* ボタンコンテナのベーススタイル */
        .button-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            z-index: 1000;
        }

        /* Pileボタン関連のスタイル */
        .pile-buttons {
            width: 100%;
        }

        .pile-selection {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .pile-buttons-row {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            gap: 10px;
            width: 100%;
        }

        .pile-button {
            width: 30%;
            padding: 10px 5px;
            white-space: nowrap;
        }

        .pile-button.selected {
            background-color: #357abd;
        }

        .pile-order-display {
            display: flex;
            gap: 100px;
        }

        .pile-order-display span {
            width: 50px;
            text-align: center;
            color: white;
            font-weight: bold;
        }

        /* 方向選択ボタン */
        .direction-buttons {
            display: none;
            gap: 20px;
        }

        /* タブレット用メディアクエリ */
        @media (max-width: 768px) {
            .button-container {
                bottom: 15px;
                gap: 8px;
            }

            .button, .pile-button {
                padding: 12px 24px;
                font-size: 1em;
            }

            .pile-button {
                padding: 8px 4px;
                font-size: 0.9em;
            }

            .pile-order-display {
                gap: 50px;
            }
        }

        /* スマートフォン用メディアクエリ */
        @media (max-width: 480px) {
            .button-container {
                bottom: 10px;
                gap: 6px;
            }

            .button {
                padding: 8px 16px;
                font-size: 0.9em;
            }

            .pile-button {
                padding: 6px 3px;
                font-size: 0.8em;
            }

            .direction-buttons {
                width: 100%;
            }

            .direction-buttons .button {
                width: calc(50% - 3px);
            }

            .pile-order-display {
                gap: 30px;
            }

            #sendThemeBtn {
                max-width: 150px;
            }
        }

        .direction-buttons {
            display: none;
            gap: 20px;
        }

        @media (max-width: 480px) {
            .direction-buttons {
                flex-direction: column;
                width: 100%;
            }

            .direction-buttons .button {
                width: 100%;
            }
        }

        .theme-input-container {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 80%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            z-index: 9000;
        }

        @media (max-width: 768px) {
            .theme-input-container {
                width: 90%;
                bottom: 80px;
                padding: 15px;
            }
        }

        textarea {
            width: 100%;
            height: 80px;
            font-size: 20px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            resize: vertical;
        }

        @media (max-width: 768px) {
            textarea {
                font-size: 16px;
                height: 60px;
            }
        }

        .meaning-container {
            margin-top: 20px;
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            max-width: 800px;
            width: 90%;
        }

        @media (max-width: 768px) {
            .meaning-container {
                padding: 15px;
                font-size: 0.9em;
            }
        }

        .status-message {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 1.2em;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 600px;
            white-space: normal;
            z-index: 5000;
        }

        @media (max-width: 768px) {
            .status-message {
                font-size: 1em;
                padding: 8px 15px;
                top: 10px;
            }
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 0;  /* パディングを0に変更 */
            text-align: center;
        }

        .loading-text {
            color: white;
            font-size: 1.2em;
            margin-top: 20px;
            text-align: center;
            padding: 0 20px;  /* テキストにのみパディングを設定 */
        }

        @media (max-width: 768px) {
            .loading-text {
                font-size: 1em;
                padding: 0 20px;
            }
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .magic-circle {
            width: 80px;
            height: 80px;
            position: relative;
            display: flex;  /* 追加 */
            justify-content: center;  /* 追加 */
            align-items: center;  /* 追加 */
        }

        @media (max-width: 768px) {
            .magic-circle {
                width: 60px;
                height: 60px;
            }
        }

        .magic-circle::before,
        .magic-circle::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid #3498db;
            border-radius: 50%;
            animation: magicRotate 3s linear infinite;
        }

        .magic-circle::after {
            width: 80%;
            height: 80%;
            top: 10%;
            left: 10%;
            border: 2px solid #f3f3f3;
            animation-direction: reverse;
        }

        .magic-circle-inner {
            position: absolute;
            width: 60%;
            height: 60%;
            top: 20%;
            left: 20%;
            border: 2px solid #e74c3c;
            border-radius: 50%;
            animation: magicRotate 2s linear infinite;
        }

        @keyframes magicRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        div {
            white-space: pre-line;
            word-wrap: break-word;
        }

        #shuffleButton {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>タロット占い</h1>
        </div>

        <div class="table-area">
            <div class="status-message" id="statusMessage"></div>
            <div class="shuffle-area" id="shuffleArea"></div>
            <div class="reading-area" id="readingArea"></div>
            <div class="theme-input-container">
                <p>何を占いますか？</p>
                <textarea id="themeInput" placeholder="結婚、仕事、恋愛運など、占いたい内容を入力してください。"></textarea>
                <button class="button" id="sendThemeBtn">占う内容を送信</button>
            </div>
            <div class="button-container">
                <button class="button" id="shuffleButton" onclick="startShuffle()">シャッフル</button>
                <div class="pile-buttons" id="pileButtons">
                    <div class="pile-selection">
                        <div class="pile-buttons-row">
                            <button class="pile-button" onclick="selectPile(0)">左の山</button>
                            <button class="pile-button" onclick="selectPile(1)">中央の山</button>
                            <button class="pile-button" onclick="selectPile(2)">右の山</button>
                        </div>
                        <div class="pile-order-display">
                            <span id="order0"></span>
                            <span id="order1"></span>
                            <span id="order2"></span>
                        </div>
                    </div>
                </div>
                <div class="direction-buttons" id="directionButtons">
                    <button class="button" onclick="rotateCards('right')">左回転</button>
                    <button class="button" onclick="rotateCards('left')">右回転</button>
                </div>
                <button class="button" id="revealButton" style="display: none">カードをめくる</button>
            </div>
        </div>

        <!-- カードの意味表示領域 -->
        <div class="meaning-container" id="meaningContainer" style="display: none;"></div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="magic-circle">
            <div class="magic-circle-inner"></div>
        </div>
        <div class="loading-text" id="loadingText">占い結果を読み解いています...</div>
    </div>

    <script>
        const ARLIAI_API_KEY = "60b9438b-c52a-4bc8-b14f-f890b724496c";
        const CARD_COUNT = 78;
        let cards = [];
        let isShuffling = false;
        let selectedPiles = [];
        let cutCount = 0;
        let currentRotationAngle = 0;
        let currentState = 'initial';
        let revealCount = 0;
        let revealedCardMessages = []; // 各カードめくり時にメッセージを保持

        // meaningsを保持する変数
        let meanings = null;

        // タロットカードのデータ
        const allCards = [
            '0_the_fool.png', '10_wheel_of_fortune.png', '12_the_hanged_man.png', '13_death.png',
            '14_temperance.png', '15_the_devil.png', '16_the_tower.png', '17_the_star.png',
            '18_the_moon.png', '19_the_sun.png', '1_the_magician.png', '20_judgement.png',
            '21_the_world.png', '2_the_high_priestes.png', '3_the_empress.png', '4_the_emperor.png',
            '5_the_hierophant.png', '6_the_lovers.png', '7_the_chariot.png', '8_strength.png',
            '11_justice.png', '9_the_hermit.png', 'ace_of_cups.png', 'ace_of_pentacles.png',
            'ace_of_swords.png', 'ace_of_wands.png', 'cups10.png', 'cups2.png', 'cups3.png',
            'cups4.png', 'cups5.png', 'cups6.png', 'cups7.png', 'cups8.png', 'cups9.png',
            'king_of_cups.png', 'king_of_pentacles.png', 'king_of_swords.png', 'king_of_wands.png',
            'knight_of_cups.png', 'knight_of_pentacles.png', 'knight_of_swords.png',
            'knight_of_wands.png', 'page_of_cups.png', 'page_of_pentacles.png',
            'page_of_swords.png', 'page_of_wands.png', 'pentacles10.png', 'pentacles2.png',
            'pentacles3.png', 'pentacles4.png', 'pentacles5.png', 'pentacles6.png',
            'pentacles7.png', 'pentacles8.png', 'pentacles9.png', 'queen_of_cups.png',
            'queen_of_pentacles.png', 'queen_of_swords.png', 'queen_of_wands.png',
            'swords10.png', 'swords2.png', 'swords3.png', 'swords4.png', 'swords5.png',
            'swords6.png', 'swords7.png', 'swords8.png', 'swords9.png', 'wands10.png',
            'wands2.png', 'wands3.png', 'wands4.png', 'wands5.png', 'wands6.png',
            'wands7.png', 'wands8.png', 'wands9.png'
        ];

        let currentDeck = [...allCards];
        let selectedCards = [];

        let themeMessageFromUser = "";
        let initialAssistantMessage = "";

        document.getElementById('sendThemeBtn').onclick = sendTheme;

        function updateStatus(message) {
            document.getElementById('statusMessage').textContent = message;
        }

        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }

        function initializeCards() {
            fetch('data/meaning.json')
                .then(response => response.json())
                .then(data => {
                    meanings = data;
                    setupTable();
                })
                .catch(err => {
                    console.error('Failed to load meanings:', err);
                    setupTable();
                });
        }

        function setupTable() {
            const shuffleArea = document.getElementById('shuffleArea');
            shuffleArea.innerHTML = '';
            cards = [];
            selectedPiles = [];
            cutCount = 0;
            currentState = 'initial';
            revealCount = 0;
            revealedCardMessages = [];

            document.getElementById('pileButtons').style.display = 'none';
            document.getElementById('directionButtons').style.display = 'none';
            document.getElementById('revealButton').style.display = 'none';
            document.getElementById('meaningContainer').style.display = 'none';
            updateStatus('');

            shuffleDeck(currentDeck); // デッキをシャッフル

            for (let i = 0; i < CARD_COUNT; i++) {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.left = '50%';
                card.style.top = '50%';
                card.style.transform = `translate(-50%, -50%) translateY(${i * 0.5}px)`;
                card.style.zIndex = i;
                card.style.backgroundImage = `url('data/back.png')`;
                shuffleArea.appendChild(card);
                cards.push(card);
            }
        }

        function sendTheme() {
            const themeInput = document.getElementById('themeInput');
            const userTheme = themeInput.value.trim();
            if (!userTheme) {
                alert("占う内容や悩みを入力してください。");
                return;
            }
            themeMessageFromUser = userTheme;
            updateStatus("質問を送信中...");
            
            // テーマ入力UIを非表示
            document.querySelector('.theme-input-container').style.display = 'none';
            
            callArliaiApiForTheme(userTheme);
        }

        async function callArliaiApiForTheme(userTheme) {
            showLoading('占いの準備をしています...');

            const systemPrompt = "あなたは凄腕のタロット占い士です。私が占いたいテーマや悩みがあります。これからあなたが占いを行いますので、占い前の会話と導入を必ず日本語でしてください。";
            const userPrompt = `私は以下のように、占いを求めています:\n「${userTheme}」\nこのことについて、あなたはこれから占いを行ってください。\n占いの前に、タロット占い師としての視点から、占う内容を明確にして、私に語りかけてください。`;

            const messages = [
                { "role": "system", "content": systemPrompt },
                { "role": "user", "content": userPrompt }
            ];

            const payload = {
                "model": "Mistral-Nemo-12B-Himeyuri-v0.1",
                "messages": messages,
                "repetition_penalty": 1.1,
                "temperature": 0.7,
                "top_p": 0.9,
                "top_k": 40,
                "max_tokens": 1024,
                "stream": false
            };

            try {
                const response = await fetch("https://api.arliai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ARLIAI_API_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error("API request failed");
                }

                const result = await response.json();
                
                // ローディングを少し表示してから結果を表示
                setTimeout(() => {
                    hideLoading();
                    initialAssistantMessage = result.choices[0].message.content;
                    updateStatus("アドバイスが届きました。シャッフルできます。");

                    const meaningContainer = document.getElementById('meaningContainer');
                    meaningContainer.style.display = 'block';
                    meaningContainer.innerHTML = `<h2>テーマへのアドバイス</h2><div style='font-size: 16px;'>${initialAssistantMessage}</div>`;

                    document.getElementById('shuffleButton').style.display = 'block';
                }, 1000);

            } catch (error) {
                console.error("Error calling ARLIAI API for theme:", error);
                hideLoading();
                updateStatus("エラーが発生しました。");
            }
        }

        function startShuffle() {
            if (isShuffling) return;
            document.getElementById('shuffleButton').style.display = 'none';
            updateStatus('カードをシャッフルしています...');
            shuffleCardsAnimation();
        }

        function shuffleCardsAnimation() {
            if (isShuffling) return;
            isShuffling = true;

            cards.forEach((card, index) => {
                setTimeout(() => {
                    const randomX = Math.random() * 300 - 150;
                    const randomY = Math.random() * 150 - 75;
                    const randomRotate = Math.random() * 360;
                    card.style.transform = `translate(calc(-50% + ${randomX}px), calc(-50% + ${randomY}px)) rotate(${randomRotate}deg)`;
                }, index * 20);
            });

            setTimeout(() => {
                cards.forEach((card, index) => {
                    setTimeout(() => {
                        card.style.transform = `translate(-50%, -50%) translateY(${index * 0.5}px) rotate(0deg)`;
                    }, index * 20);
                });
                
                setTimeout(() => {
                    isShuffling = false;
                    updateStatus('山札を3つに分けています...');
                    divideIntoThreePiles();
                }, CARD_COUNT * 20 + 500);
            }, CARD_COUNT * 20 + 1000);
        }

        function shuffle() {
            if (isShuffling) return;
            isShuffling = true;

            cards.forEach((card, index) => {
                setTimeout(() => {
                    const randomX = Math.random() * 300 - 150;
                    const randomY = Math.random() * 150 - 75;
                    const randomRotate = Math.random() * 360;
                    card.style.transform = `translate(calc(-50% + ${randomX}px), calc(-50% + ${randomY}px)) rotate(${randomRotate}deg)`;
                }, index * 20);
            });

            setTimeout(() => {
                cards.forEach((card, index) => {
                    setTimeout(() => {
                        card.style.transform = `translate(-50%, -50%) translateY(${index * 0.5}px) rotate(0deg)`;
                    }, index * 20);
                });
                
                setTimeout(() => {
                    isShuffling = false;
                }, CARD_COUNT * 20 + 500);
            }, CARD_COUNT * 20 + 1000);
        }

        function divideIntoThreePiles() {
            const pilePositions = getPilePositions();

            cards.forEach((card, index) => {
                const pile = index % 3;
                const pileOffset = Math.floor(index / 3) * 0.5;
                setTimeout(() => {
                    card.style.transform = `
                        translate(calc(-50% + ${pilePositions[pile].x}px), 
                        calc(-50% + ${pilePositions[pile].y + pileOffset}px))
                        rotate(90deg)
                    `;
                }, index * 50);
            });

            setTimeout(() => {
                currentState = 'selecting_piles';
                document.getElementById('pileButtons').style.display = 'flex';
                updateStatus('山札を重ねる順番を選択してください（左から1,2,3）');
            }, CARD_COUNT * 50 + 500);
        }

        function getPilePositions() {
            // 画面幅に基づいて位置を計算
            if (window.innerWidth <= 480) {
                // スマートフォン向け
                return [
                    { x: -120, y: 0 },
                    { x: 0, y: 0 },
                    { x: 120, y: 0 }
                ];
            } else if (window.innerWidth <= 768) {
                // タブレット向け
                return [
                    { x: -200, y: 0 },
                    { x: 0, y: 0 },
                    { x: 200, y: 0 }
                ];
            } else {
                // デスクトップ向け（元のサイズ）
                return [
                    { x: -300, y: 0 },
                    { x: 0, y: 0 },
                    { x: 300, y: 0 }
                ];
            }
        }

        function selectPile(pileIndex) {
            if (selectedPiles.includes(pileIndex) || currentState !== 'selecting_piles') return;
            
            const buttons = document.querySelectorAll('.pile-button');
            buttons[pileIndex].classList.add('selected');
            buttons[pileIndex].disabled = true;

            const orderSpan = document.getElementById(`order${pileIndex}`);
            orderSpan.textContent = `${selectedPiles.length + 1}番目`;

            selectedPiles.push(pileIndex);

            if (selectedPiles.length === 3) {
                setTimeout(() => {
                    document.getElementById('pileButtons').style.display = 'none';
                    stackPiles();
                }, 500);
            }
        }

        function stackPiles() {
            updateStatus('山札を重ねています...');
            let delay = 0;

            selectedPiles.forEach((pileIndex, stackOrder) => {
                const cardsInPile = cards.filter((_, index) => index % 3 === pileIndex);
                
                cardsInPile.forEach((card, indexInPile) => {
                    setTimeout(() => {
                        card.style.transform = `
                            translate(-50%, -50%)
                            translateY(${(stackOrder * cardsInPile.length + indexInPile) * 0.5}px)
                            rotate(90deg)
                        `;
                    }, delay);
                    delay += 20;
                });
            });

            setTimeout(() => {
                document.getElementById('directionButtons').style.display = 'flex';
                currentState = 'selecting_direction';
                updateStatus('カードの向きを選択してください（右回転/左回転）');
            }, delay + 500);
        }

        function rotateCards(direction) {
            if (currentState !== 'selecting_direction') return;

            currentRotationAngle = direction === 'right' ? 0 : 180;
            updateStatus('カードの向きを設定しています...');

            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.transform = `
                        translate(-50%, -50%)
                        translateY(${index * 0.5}px)
                        rotate(${currentRotationAngle}deg)
                    `;
                }, index * 20);
            });

            setTimeout(() => {
                document.getElementById('directionButtons').style.display = 'none';
                currentState = 'cutting';
                setupCutting();
            }, CARD_COUNT * 20 + 500);
        }

        function setupCutting() {
            updateStatus('山札をカットする位置をクリックしてください（あと3回）');

            cards.forEach((card, index) => {
                card.style.transform = `
                    translate(-50%, -50%)
                    translateX(${index * 0.5}px)
                    translateY(${index * 0.8}px)
                    rotate(${currentRotationAngle}deg)
                `;
                card.style.zIndex = 1000 + index;
                card.style.cursor = 'pointer';
                card.style.pointerEvents = 'auto';

                card.onclick = (e) => {
                    e.stopPropagation();
                    if (currentState === 'cutting' && cutCount < 3) {
                        performCut(index);
                    }
                };
            });
        }

        function performCut(cutIndex) {
            if (currentState !== 'cutting' || cutIndex === 0 || cutIndex === cards.length - 1) return;

            const upperPile = cards.slice(cutIndex);
            const lowerPile = cards.slice(0, cutIndex);
            const upperDeck = currentDeck.slice(cutIndex);
            const lowerDeck = currentDeck.slice(0, cutIndex);

            upperPile.forEach((card, index) => {
                card.style.transform = `
                    translate(-50%, -50%)
                    translateX(200px)
                    translateY(${index * 0.5}px)
                    rotate(${currentRotationAngle}deg)
                `;
                card.style.zIndex = 2000 + index;
            });

            setTimeout(() => {
                const newOrder = [...lowerPile, ...upperPile];
                const newDeck = [...lowerDeck, ...upperDeck];

                newOrder.forEach((card, index) => {
                    card.style.transform = `
                        translate(-50%, -50%)
                        translateX(${index * 0.5}px)
                        translateY(${index * 0.8}px)
                        rotate(${currentRotationAngle}deg)
                    `;
                    card.style.zIndex = 1000 + index;
                });

                cards = newOrder;
                currentDeck = newDeck;

            }, 500);

            cutCount++;
            updateStatus(`山札をカットする位置をクリックしてください（あと${3 - cutCount}回）`);

            if (cutCount >= 3) {
                cards.forEach(card => {
                    card.onclick = null;
                    card.style.cursor = 'default';
                    card.style.pointerEvents = 'none';
                });
                setTimeout(() => {
                    updateStatus('カードの準備をしています...');
                    currentState = 'complete';
                    prepareDrawing();
                }, 1000);
            }
        }

        function prepareDrawing() {
            updateStatus('カードを配置しています...');

            cards.forEach((card, index) => {
                card.style.transform = `
                    translate(-50%, calc(-50% - 300px))
                    translateY(${index * 0.5}px)
                    rotate(${currentRotationAngle}deg)
                `;
                card.style.zIndex = 1000 + index;
            });

            const readingArea = document.getElementById('readingArea');
            readingArea.style.display = 'flex';

            setTimeout(dealCards, 1000);
        }

        function getCardPosition(element) {
            const rect = element.getBoundingClientRect();
            const tableArea = document.querySelector('.table-area').getBoundingClientRect();
            
            return {
                left: rect.left - tableArea.left,
                top: rect.top - tableArea.top,
                width: rect.width,
                height: rect.height
            };
        }

        async function dealCards() {
            selectedCards = [];
            const readingArea = document.getElementById('readingArea');
            readingArea.innerHTML = '';
            
            for (let i = 0; i < 3; i++) {
                const cardElement = cards.pop();
                const cardData = currentDeck.pop();
                const isReversed = Math.random() < 0.5;

                selectedCards.push({ filename: cardData, isReversed: isReversed });

                const startPosition = getCardPosition(cardElement);
                cardElement.style.transition = 'none';
                cardElement.style.position = 'absolute';
                cardElement.style.left = `${startPosition.left}px`;
                cardElement.style.top = `${startPosition.top}px`;
                cardElement.style.width = `${startPosition.width}px`;
                cardElement.style.height = `${startPosition.height}px`;
                cardElement.style.margin = '0';
                cardElement.style.transform = `rotate(${currentRotationAngle}deg)`;
                cardElement.style.zIndex = 2000 + i;

                readingArea.appendChild(cardElement);

                const front = document.createElement('div');
                front.className = 'front';
                front.style.backgroundImage = `url('data/${cardData}')`;

                const back = document.createElement('div');
                back.className = 'back';
                back.style.backgroundImage = `url('data/back.png')`;

                // 画面幅に応じてxOffsetを調整
                let xOffset;
                if (window.innerWidth <= 480) {
                    xOffset = (i - 1) * 70;  // スマートフォン用
                } else if (window.innerWidth <= 768) {
                    xOffset = (i - 1) * 140; // タブレット用
                } else {
                    xOffset = (i - 1) * 220; // デスクトップ用（既存の値）
                }

                const targetLeft = readingArea.offsetWidth / 2 - startPosition.width / 2 + xOffset;
                const targetTop = readingArea.offsetHeight / 2 - startPosition.height / 2;


                await new Promise(resolve => {
                    requestAnimationFrame(() => {
                        cardElement.style.transition = 'all 0.8s ease-out';
                        cardElement.style.left = `${targetLeft}px`;
                        cardElement.style.top = `${targetTop}px`;
                        cardElement.style.transform = `rotate(${currentRotationAngle}deg)`;
                        
                        setTimeout(() => {
                            cardElement.classList.remove('card');
                            cardElement.classList.add('reading-card');
                            cardElement.innerHTML = '';
                            cardElement.appendChild(front);
                            cardElement.appendChild(back);
                            if (isReversed) {
                                front.style.transform = 'rotateY(180deg) rotate(180deg)';
                            }
                            resolve();
                        }, 800);
                    });
                });

                await new Promise(resolve => setTimeout(resolve, 200));
            }

            updateStatus('カードが準備できました');
            const revealButton = document.getElementById('revealButton');
            revealButton.style.display = 'block';
            revealButton.onclick = handleReveal;
        }

        // カード画像名から意味を取得するヘルパー関数
        function getCardMeaning(cardFilename, meanings) {
            if (!meanings) return null;

            // Major Arcana判定（先頭が0〜21_となっている場合）
            const majorMatch = cardFilename.match(/^(\d+)_/);
            if (majorMatch) {
                const number = parseInt(majorMatch[1], 10);
                const major = meanings.major_arcana.find(m => m.number === number);
                return major ? {
                    name: major.name,
                    positive: major.positive,
                    negative: major.negative
                } : null;
            }

            const minorMatch = cardFilename.match(/^(\w+)_of_(\w+).png$/);
            if (minorMatch) {
                const rank = minorMatch[1];  
                const suit = minorMatch[2];  
                let suitArray = [];
                switch (suit) {
                    case 'wands': suitArray = meanings.minor_arcana.wands; break;
                    case 'cups': suitArray = meanings.minor_arcana.cups; break;
                    case 'swords': suitArray = meanings.minor_arcana.swords; break;
                    case 'pentacles': suitArray = meanings.minor_arcana.pentacles; break;
                    default: return null;
                }
                const cardMeaning = suitArray.find(c => c.rank.toLowerCase() === rank);
                return cardMeaning ? {
                    name: cardMeaning.name,
                    meaning: cardMeaning.meaning
                } : null;
            }

            const pattern2 = /^(wands|cups|swords|pentacles)(\d+).png$/;
            const match2 = cardFilename.match(pattern2);
            if (match2) {
                const suit = match2[1];
                const num = match2[2];
                let suitArray = [];
                switch (suit) {
                    case 'wands': suitArray = meanings.minor_arcana.wands; break;
                    case 'cups': suitArray = meanings.minor_arcana.cups; break;
                    case 'swords': suitArray = meanings.minor_arcana.swords; break;
                    case 'pentacles': suitArray = meanings.minor_arcana.pentacles; break;
                }
                const cardMeaning = suitArray.find(c => c.rank === num);
                return cardMeaning ? {
                    name: cardMeaning.name,
                    meaning: cardMeaning.meaning
                } : null;
            }

            return null;
        }

        function handleReveal() {
            if (revealCount >= selectedCards.length) return;

            const cardsDealt = document.querySelectorAll('.reading-card');
            const cardToReveal = cardsDealt[revealCount];

            cardToReveal.style.transform = 'rotateY(180deg)';

            const cardInfo = selectedCards[revealCount];
            const cardMeaningObj = getCardMeaning(cardInfo.filename, meanings);

            const meaningContainer = document.getElementById('meaningContainer');
            meaningContainer.style.display = 'block';

            let message = '';
            let orientation = cardInfo.isReversed ? '逆位置' : '正位置';
            let simpleMeaning = '';

            if (cardMeaningObj) {
                if (cardMeaningObj.positive && cardMeaningObj.negative) {
                    if (cardInfo.isReversed) {
                        message = `<h2>${cardMeaningObj.name}（逆位置）</h2><p><strong>ネガティブ面:</strong> ${cardMeaningObj.negative.join('、')}</p>`;
                        simpleMeaning = `逆位置: ${cardMeaningObj.negative.join('、')}`;
                    } else {
                        message = `<h2>${cardMeaningObj.name}（正位置）</h2><p><strong>ポジティブ面:</strong> ${cardMeaningObj.positive.join('、')}</p>`;
                        simpleMeaning = `正位置: ${cardMeaningObj.positive.join('、')}`;
                    }
                } else {
                    if (cardInfo.isReversed) {
                        message = `<h2>${cardMeaningObj.name}（逆位置）</h2><p>${cardMeaningObj.meaning}（逆位置で停滞）</p>`;
                        simpleMeaning = `逆位置: ${cardMeaningObj.meaning}（停滞）`;
                    } else {
                        message = `<h2>${cardMeaningObj.name}（正位置）</h2><p>${cardMeaningObj.meaning}</p>`;
                        simpleMeaning = `正位置: ${cardMeaningObj.meaning}`;
                    }
                }
            } else {
                message = `<h2>不明なカード</h2><p>意味が見つかりません。</p>`;
                simpleMeaning = `意味不明`;
            }

            meaningContainer.innerHTML += message;

            revealedCardMessages.push({
                name: cardMeaningObj ? cardMeaningObj.name : cardInfo.filename,
                orientation: orientation,
                meaning: simpleMeaning
            });

            revealCount++;

            if (revealCount >= selectedCards.length) {
                document.getElementById('revealButton').style.display = 'none';
                updateStatus('リーディングが完了しました');

                setTimeout(function() {
                    // 全カード表示後に再度ARLIAI APIへ総合リーディング問い合わせ
                    callArliaiApiForFinalReading();
                }, 3000);
            }
        }

        // ローディング表示の制御関数を追加
        function showLoading(message) {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = message;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }

        async function callArliaiApiForFinalReading() {

            showLoading('タロットカードからのメッセージを読み解いています...');

            const systemPrompt = "あなたは凄腕のタロット占い士です。必ず日本語で占いの結果を告げてください。";
            let userPrompt = `私は「${themeMessageFromUser}」について占いを求めています。\n`;
            userPrompt += `占い前、あなたは以下のアドバイスを伝えました:\n「${initialAssistantMessage}」\n\n`;
            userPrompt += "ここで3枚のタロットカードが展開され、それぞれ以下のような意味を持っています。\n\n";
            userPrompt += `【過去】 1枚目: ${revealedCardMessages[0].name}（${revealedCardMessages[0].orientation}）\n意味: ${revealedCardMessages[0].meaning}\n\n`;
            userPrompt += `【現在】 2枚目: ${revealedCardMessages[1].name}（${revealedCardMessages[1].orientation}）\n意味: ${revealedCardMessages[1].meaning}\n\n`;
            userPrompt += `【未来】 3枚目: ${revealedCardMessages[2].name}（${revealedCardMessages[2].orientation}）\n意味: ${revealedCardMessages[2].meaning}\n\n`;
            userPrompt += "これらを踏まえて、私のテーマについて、過去・現在・未来の流れと、今後取るべきアクションをユ私に対して総合的にアドバイスしてください。";

            const messages = [
                { "role": "system", "content": systemPrompt },
                { "role": "user", "content": userPrompt }
            ];

            const payload = {
                "model": "Mistral-Nemo-12B-Instruct-2407",
                "messages": messages,
                "repetition_penalty": 1.1,
                "temperature": 0.7,
                "top_p": 0.9,
                "top_k": 40,
                "max_tokens": 1024,
                "stream": false
            };

            try {
                const response = await fetch("https://api.arliai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ARLIAI_API_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error("API request failed");
                }

                const result = await response.json();

                // ローディングを少し表示してから結果を表示（より神秘的な演出のため）
                setTimeout(() => {
                    hideLoading();
                    const meaningContainer = document.getElementById('meaningContainer');
                    meaningContainer.innerHTML += `<hr><h2>総合リーディング結果</h2><div  style='font-size: 16px;'>${result.choices[0].message.content}</div>`;
                    
                    // 結果表示時にスクロールアニメーション
                    meaningContainer.scrollIntoView({ behavior: 'smooth' });
                }, 1500);

            } catch (error) {
                console.error("Error calling final reading:", error);
                hideLoading();
                updateStatus('申し訳ありません。リーディング中にエラーが発生しました。');
            }
        }

        window.onload = initializeCards;
    </script>
</body>
</html>
